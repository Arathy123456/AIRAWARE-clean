<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Air Quality Health Dashboard</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
   <style>
       :root {
           --primary: #4361ee;
           --primary-dark: #3a0ca3;
           --primary-light: rgba(67, 97, 238, 0.1);
           --secondary: #3f37c9;
           --success: #4cc9f0;
           --success-light: rgba(76, 201, 240, 0.1);
           --warning: #f72585;
           --warning-light: rgba(247, 37, 133, 0.1);
           --info: #4895ef;
           --info-light: rgba(72, 149, 239, 0.1);
           --danger: #f94144;
           --danger-light: rgba(249, 65, 68, 0.1);
           --neutral: #ebebeb;
           --border-radius: 0.75rem;
           --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
           --transition: all 0.25s ease;
       }

       body {
           background: #f8f9fa;
           font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
           color: #2b2d42;
           line-height: 1.5;
       }

       .dashboard-container {
           max-width: 1200px;
           margin: 0.75rem auto;
           padding: 0 0.75rem;
       }

       .header-section {
           padding: 1.5rem;
           background: linear-gradient(135deg, #4361ee, #7209b7);
           border-radius: var(--border-radius);
           color: white;
           margin-bottom: 1rem;
           position: relative;
           overflow: hidden;
           text-align: center;
       }

       .header-section::before {
           content: '';
           position: absolute;
           top: -50px;
           right: -50px;
           width: 200px;
           height: 200px;
           border-radius: 50%;
           background: rgba(255, 255, 255, 0.1);
           z-index: 0;
       }

       .header-content {
           position: relative;
           z-index: 1;
       }

       .header-content h1 {
           font-weight: 700;
           margin-bottom: 0.5rem;
           font-size: 1.75rem;
       }

       .header-content p {
           opacity: 0.9;
           margin-bottom: 0;
           font-size: 0.95rem;
       }

       .overview-bar {
           display: flex;
           justify-content: space-between;
           background: white;
           border-radius: var(--border-radius);
           padding: 0.75rem;
           margin-bottom: 1rem;
           box-shadow: var(--shadow-sm);
       }

       .overview-item {
           text-align: center;
           padding: 0.25rem 0.5rem;
           border-right: 1px solid rgba(0,0,0,0.07);
           flex: 1;
       }

       .overview-item:last-child {
           border-right: none;
       }

       .overview-label {
           font-size: 0.75rem;
           color: #6c757d;
           display: block;
           margin-bottom: 0.25rem;
       }

       .overview-value {
           font-size: 0.9rem;
           font-weight: 600;
           color: var(--primary);
       }

       .metric-card {
           background: white;
           border-radius: var(--border-radius);
           padding: 1rem;
           margin-bottom: 1rem;
           box-shadow: var(--shadow-sm);
           transition: var(--transition);
           border: 1px solid rgba(0,0,0,0.03);
       }

       .card-header-custom {
           display: flex;
           align-items: center;
           justify-content: space-between;
           margin-bottom: 0.75rem;
           padding-bottom: 0.5rem;
           border-bottom: 1px solid rgba(0,0,0,0.05);
       }

       .card-title {
           font-weight: 600;
           font-size: 1rem;
           margin: 0;
           display: flex;
           align-items: center;
           gap: 0.5rem;
       }

       .card-title i {
           color: var(--primary);
       }

       .card-badge {
           background: var(--primary-light);
           color: var(--primary);
           padding: 0.15rem 0.5rem;
           border-radius: 1rem;
           font-size: 0.7rem;
           font-weight: 600;
       }

       .health-score-container {
           display: flex;
           align-items: center;
           justify-content: space-around;
           padding: 0.75rem;
       }

       .health-score {
           font-size: 3.5rem;
           font-weight: 800;
           color: var(--primary);
           text-align: center;
           line-height: 1;
           text-shadow: 0 2px 8px rgba(67, 97, 238, 0.2);
       }

       .status-indicator {
           display: inline-block;
           padding: 0.5rem 1rem;
           border-radius: 1rem;
           font-weight: 600;
           text-align: center;
           min-width: 120px;
           box-shadow: 0 2px 8px rgba(0,0,0,0.05);
           text-transform: uppercase;
           letter-spacing: 0.5px;
           font-size: 0.8rem;
       }

       .status-good {
           background: var(--success-light);
           color: var(--success);
           border: 1px solid var(--success);
       }

       .status-warning {
           background: var(--warning-light);
           color: var(--warning);
           border: 1px solid var(--warning);
       }

       .status-danger {
           background: var(--danger-light);
           color: var(--danger);
           border: 1px solid var(--danger);
       }

       .aqi-grid {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
           gap: 0.75rem;
       }

       .aqi-item {
           background: var(--primary-light);
           padding: 0.75rem 0.5rem;
           border-radius: 0.75rem;
           text-align: center;
           transition: var(--transition);
           border: 1px solid rgba(67, 97, 238, 0.15);
       }

       .aqi-item:hover {
           transform: translateY(-3px);
       }

       .aqi-value {
           font-size: 1.25rem;
           font-weight: 700;
           color: var(--primary);
           margin-bottom: 0.25rem;
       }

       .aqi-label {
           font-size: 0.7rem;
           color: #6c757d;
           font-weight: 500;
           text-transform: uppercase;
           letter-spacing: 0.5px;
       }

       .alert-card {
           border-radius: var(--border-radius);
           background: white;
           padding: 1rem;
           margin-bottom: 1rem;
           box-shadow: var(--shadow-sm);
           display: flex;
           align-items: stretch;
           border-left: 4px solid var(--info);
       }

       .alert-icon {
           display: flex;
           align-items: center;
           justify-content: center;
           padding-right: 0.75rem;
           margin-right: 0.75rem;
           border-right: 1px solid rgba(0,0,0,0.05);
           font-size: 1.5rem;
           color: var(--info);
       }

       .alert-content {
           flex-grow: 1;
       }

       .alert-title {
           font-weight: 700;
           color: var(--info);
           margin-bottom: 0.25rem;
           font-size: 0.95rem;
       }

       .alert-message {
           margin-bottom: 0.5rem;
           color: #2b2d42;
           font-size: 0.85rem;
       }

       .alert-actions {
           display: flex;
           gap: 0.5rem;
       }

       .btn-alert {
           padding: 0.3rem 0.75rem;
           border-radius: 0.5rem;
           font-size: 0.75rem;
           font-weight: 600;
           text-decoration: none;
           transition: var(--transition);
           display: inline-flex;
           align-items: center;
           gap: 0.3rem;
       }

       .btn-primary-outline {
           color: var(--info);
           border: 1px solid var(--info);
           background: var(--info-light);
       }

       .btn-primary-outline:hover {
           background: var(--info);
           color: white;
       }

       .news-section {
           margin-bottom: 1rem;
       }

       .news-card {
           display: flex;
           padding: 0.75rem;
           border-bottom: 1px solid rgba(0,0,0,0.05);
           transition: var(--transition);
       }

       .news-card:last-child {
           border-bottom: none;
       }

       .news-card:hover {
           background: rgba(0,0,0,0.02);
       }

       .news-icon {
           font-size: 1.25rem;
           color: var(--primary);
           margin-right: 0.75rem;
           flex-shrink: 0;
       }

       .news-content h4 {
           font-size: 0.9rem;
           font-weight: 600;
           margin-bottom: 0.25rem;
           color: #2b2d42;
       }

       .news-content p {
           font-size: 0.8rem;
           margin-bottom: 0.25rem;
           color: #6c757d;
       }

       .news-source {
           font-size: 0.7rem;
           color: var(--primary);
           font-weight: 500;
       }

       .govt-links {
           display: flex;
           flex-wrap: wrap;
           gap: 0.5rem;
           margin-top: 0.5rem;
       }

       .govt-link {
           font-size: 0.7rem;
           padding: 0.3rem 0.6rem;
           background: var(--primary-light);
           color: var(--primary);
           border-radius: 1rem;
           text-decoration: none;
           transition: var(--transition);
           display: inline-flex;
           align-items: center;
           gap: 0.3rem;
       }

       .govt-link:hover {
           background: var(--primary);
           color: white;
       }

       .forecast-section {
           padding: 0;
       }

       .tab-navigation {
           display: flex;
           border-bottom: 1px solid rgba(0,0,0,0.05);
           padding-bottom: 1px;
           gap: 0.25rem;
           overflow-x: auto;
           scrollbar-width: none;
       }

       .tab-navigation::-webkit-scrollbar {
           display: none;
       }

       .tab-item {
           cursor: pointer;
           padding: 0.5rem 0.75rem;
           font-weight: 600;
           color: #6c757d;
           border-bottom: 2px solid transparent;
           transition: var(--transition);
           white-space: nowrap;
           font-size: 0.85rem;
       }

       .tab-item.active {
           color: var(--primary);
           border-bottom-color: var(--primary);
       }

       .parameter-controls {
           display: flex;
           flex-wrap: wrap;
           gap: 0.5rem;
           margin: 0.75rem 0;
       }

       .parameter-btn {
           padding: 0.5rem 0.75rem;
           background: var(--primary-light);
           border: 1px solid rgba(67, 97, 238, 0.2);
           border-radius: 0.5rem;
           color: var(--primary);
           cursor: pointer;
           transition: var(--transition);
           font-weight: 500;
           font-size: 0.8rem;
           display: inline-flex;
           align-items: center;
           gap: 0.3rem;
       }

       .parameter-btn:hover {
           background: rgba(67, 97, 238, 0.15);
           transform: translateY(-2px);
       }

       .parameter-btn.active {
           background: var(--primary);
           color: white;
           border-color: var(--primary-dark);
       }

       .forecast-chart-container {
           background: white;
           border-radius: var(--border-radius);
           padding: 0.75rem;
           margin-bottom: 0.75rem;
           box-shadow: var(--shadow-sm);
           border: 1px solid rgba(0,0,0,0.03);
           height: 250px;
       }

       .forecast-table {
           width: 100%;
           border-collapse: separate;
           border-spacing: 0;
           border-radius: 0.5rem;
           overflow: hidden;
           margin-bottom: 0.75rem;
           box-shadow: var(--shadow-sm);
           font-size: 0.8rem;
       }

       .forecast-table th,
       .forecast-table td {
           padding: 0.6rem;
           text-align: center;
           border-bottom: 1px solid #e5e7eb;
       }

       .forecast-table th {
           background: rgba(67, 97, 238, 0.05);
           font-weight: 600;
           color: #2b2d42;
       }

       .forecast-table tbody tr:last-child td {
           border-bottom: none;
       }

       .recommendation-card {
           display: flex;
           align-items: flex-start;
           gap: 0.75rem;
           padding: 0.75rem;
           border-radius: 0.5rem;
           margin-bottom: 0.75rem;
           background: var(--primary-light);
           transition: var(--transition);
           border: 1px solid rgba(67, 97, 238, 0.1);
       }

       .recommendation-icon {
           width: 32px;
           height: 32px;
           border-radius: 50%;
           background: white;
           display: flex;
           align-items: center;
           justify-content: center;
           color: var(--primary);
           font-size: 0.9rem;
           flex-shrink: 0;
       }

       .recommendation-content h4 {
           font-size: 0.9rem;
           font-weight: 600;
           margin-bottom: 0.25rem;
           color: var(--primary);
       }

       .recommendation-content p {
           font-size: 0.8rem;
           margin-bottom: 0.25rem;
           color: #2b2d42;
       }

       .recommendation-actions {
           margin-top: 0.5rem;
       }

       .btn-recommendation {
           display: inline-flex;
           align-items: center;
           gap: 0.3rem;
           padding: 0.25rem 0.5rem;
           border-radius: 0.35rem;
           font-size: 0.7rem;
           font-weight: 600;
           color: var(--primary);
           background: white;
           border: 1px solid rgba(67, 97, 238, 0.15);
           text-decoration: none;
           transition: var(--transition);
       }

       .btn-recommendation:hover {
           background: var(--primary);
           color: white;
       }

       .detail-section {
           margin-top: 1rem;
       }

       .detail-table {
           width: 100%;
           border-collapse: separate;
           border-spacing: 0;
           margin-bottom: 0;
           font-size: 0.8rem;
       }

       .detail-table td {
           padding: 0.75rem;
           border-bottom: 1px solid #e5e7eb;
           vertical-align: middle;
       }

       .detail-table tr:last-child td {
           border-bottom: none;
       }

       .pill-badge {
           display: inline-block;
           padding: 0.2rem 0.5rem;
           border-radius: 1rem;
           font-size: 0.7rem;
           font-weight: 600;
           margin-right: 0.3rem;
           margin-bottom: 0.3rem;
           background: #ebebeb;
           color: #6c757d;
       }

       .mobile-tabs {
           display: none;
       }

       @media (max-width: 767px) {
           .mobile-tabs {
               display: flex;
               justify-content: space-between;
               margin-bottom: 1rem;
           }

           .mobile-tab {
               flex: 1;
               text-align: center;
               padding: 0.5rem;
               background: white;
               border-radius: 0.35rem;
               margin: 0 0.15rem;
               box-shadow: var(--shadow-sm);
               font-weight: 600;
               font-size: 0.7rem;
               color: #6c757d;
               cursor: pointer;
           }

           .mobile-tab.active {
               background: var(--primary);
               color: white;
           }

           .mobile-section {
               display: none;
           }

           .mobile-section.active {
               display: block;
           }
       }

       @media (max-width: 575px) {
           .overview-bar {
               flex-wrap: wrap;
           }

           .overview-item {
               flex-basis: 50%;
               border-right: none;
               padding: 0.5rem 0;
           }

           .overview-item:nth-child(odd) {
               border-right: 1px solid rgba(0,0,0,0.07);
           }

           .health-score {
               font-size: 2.5rem;
           }

           .aqi-grid {
               grid-template-columns: repeat(2, 1fr);
           }

           .alert-icon {
               display: none;
           }

           .forecast-chart-container {
               height: 200px;
           }
       }
   </style>
</head>
<body>

   <div class="dashboard-container">
       <!-- Header Section -->
       <div class="header-section">
          <div class="header-content">
              <h1>Know Your Health, {{ request.session.name }}!</h1>
              <p>Real-time environmental data for your wellbeing</p>
          </div>
       </div>

       <!-- Overview Bar -->
       <div class="overview-bar">
           <div class="overview-item">
               <span class="overview-label">Date</span>
               <span class="overview-value" id="current-date">{{ current_date }}</span>
           </div>
           <div class="overview-item">
               <span class="overview-label">Location</span>
               <span class="overview-value">{{ location }}</span>
           </div>
           <div class="overview-item">
               <span class="overview-label">Last Updated</span>
               <span class="overview-value" id="last-updated">{{ last_updated }}</span>
           </div>
           <div class="overview-item">
               <span class="overview-label">Status</span>
               <span class="overview-value" id="health-status">
                 {% if health_score >= 80 %}Good
                 {% elif health_score >= 60 %}Moderate
                 {% else %}Needs Attention{% endif %}
              </span>
           </div>
       </div>

       <!-- Mobile Tabs -->
       <div class="mobile-tabs">
           <div class="mobile-tab active" data-target="score-section">Score</div>
           <div class="mobile-tab" data-target="metrics-section">AQI</div>
           <div class="mobile-tab" data-target="forecast-section">Forecast</div>
           <div class="mobile-tab" data-target="news-section">News</div>
       </div>

       <div class="row g-2">

           <div class="col-md-4 mobile-section active" id="score-section">
               <div class="metric-card">
                   <div class="card-header-custom">
                       <h3 class="card-title"><i class="fas fa-heartbeat"></i> Health Score</h3>
                       <span class="card-badge">Announcements</span>
                   </div>
                   <div class="health-score-container">
                       <div class="health-score">{{ health_score }}</div>
                       <div>
                           <span class="status-indicator
                               {% if health_score >= 80 %}status-good
                               {% elif health_score >= 60 %}status-warning
                               {% else %}status-danger{% endif %}">
                               {% if health_score >= 80 %}Excellent
                               {% elif health_score >= 60 %}Good
                               {% else %}Caution{% endif %}
                           </span>
                       </div>
                   </div>
               </div>

               <!-- Alert Card -->
               {% if alert_message %}
               <div class="alert-card">
                   <div class="alert-icon">
                       <i class="fas fa-info-circle"></i>
                   </div>
                   <div class="alert-content">
                       <div class="alert-title">Health Insight</div>
                       <div class="alert-message">{{ alert_message }}</div>
                       <div class="alert-actions">
                           <a href="#recommendations" class="btn-alert btn-primary-outline">
                               <i class="fas fa-check"></i> See Tips
                           </a>
                       </div>
                   </div>
               </div>
               {% endif %}
           </div>

           <!-- Air Quality Metrics -->
           <div class="col-md-8 mobile-section" id="metrics-section">
               <div class="metric-card">
                   <div class="card-header-custom">
                       <h3 class="card-title"><i class="fas fa-wind"></i> Air Quality Index</h3>
                       <span class="card-badge">Live Data</span>
                   </div>
                   <div class="aqi-grid">
                       <div class="aqi-item">
                           <div class="aqi-value" id="co">{{ aqi_data.co_level }}</div>
                           <div class="aqi-label">CO</div>
                       </div>
                       <div class="aqi-item">
                           <div class="aqi-value" id="no2">{{ aqi_data.no2_level }}</div>
                           <div class="aqi-label">NO₂</div>
                       </div>
                       <div class="aqi-item">
                           <div class="aqi-value" id="pm25">{{ aqi_data.pm25_level }}</div>
                           <div class="aqi-label">PM2.5</div>
                       </div>
                       <div class="aqi-item">
                           <div class="aqi-value" id="pm10">{{ aqi_data.pm10_level }}</div>
                           <div class="aqi-label">PM10</div>
                       </div>
                       <div class="aqi-item">
                           <div class="aqi-value" id="so2">{{ aqi_data.so2_level }}</div>
                           <div class="aqi-label">SO₂</div>
                       </div>
                       <div class="aqi-item">
                           <div class="aqi-value" id="nh3">{{ aqi_data.nh3_level }}</div>
                           <div class="aqi-label">NH₃</div>
                       </div>
                       <div class="aqi-item">
                           <div class="aqi-value" id="o3">{{ aqi_data.o3_level }}</div>
                           <div class="aqi-label">O₃</div>
                       </div>
                   </div>
               </div>
           </div>

           <!-- News & Updates Section -->
           <div class="col-md-4 mobile-section" id="news-section">
               <div class="metric-card news-section">
                   <div class="card-header-custom">
                       <h3 class="card-title"><i class="fas fa-newspaper"></i> News & Updates</h3>
                       <span class="card-badge">Latest</span>
                   </div>

                   <div class="news-card">
                       <div class="news-icon">
                           <i class="fas fa-bullhorn"></i>
                       </div>
                       <div class="news-content">
                           <h4>Air Quality Alert Issued</h4>
                           <p>The Ministry of Environment has issued an air quality advisory for the region due to elevated PM2.5 levels.</p>
                           <span class="news-source">Source: Ministry of Environment</span>
                       </div>
                   </div>

                   <div class="news-card">
                       <div class="news-icon">
                           <i class="fas fa-leaf"></i>
                       </div>
                       <div class="news-content">
                           <h4>New Green Initiative Launched</h4>
                           <p>Local government announces new measures to improve air quality in urban areas.</p>
                           <span class="news-source">Source: City Environmental Office</span>
                       </div>
                   </div>

                   <div class="news-card">
                       <div class="news-icon">
                           <i class="fas fa-cloud-sun"></i>
                       </div>
                       <div class="news-content">
                           <h4>Seasonal Air Quality Forecast</h4>
                           <p>Experts predict improving air quality conditions over the next month with seasonal changes.</p>
                           <span class="news-source">Source: Meteorological Department</span>
                       </div>
                   </div>


                   <div class="govt-links">
                       <a href="https://cpcb.nic.in/" class="govt-link" target="_blank">
                           <i class="fas fa-external-link-alt"></i> CPCB
                       </a>
                       <a href="https://www.safar.tropmet.res.in/" class="govt-link" target="_blank">
                           <i class="fas fa-external-link-alt"></i> SAFAR
                       </a>
                       <a href="https://mausam.imd.gov.in/" class="govt-link" target="_blank">
                           <i class="fas fa-external-link-alt"></i> IMD
                       </a>
                       <!--<a href="https://www.aqi.in/in" class="govt-link" target="_blank">
                           <i class="fas fa-external-link-alt"></i> AQI.in
                       </a>-->
                   </div>
               </div>
           </div>

           <!-- Forecast Section -->
           <div class="col-md-8 mobile-section" id="forecast-section">
               <div class="metric-card forecast-section">
                   <div class="card-header-custom">
                       <h3 class="card-title"><i class="fas fa-chart-line"></i> Air Quality Forecast</h3>
                       <span class="card-badge">Updated: {{ forecast_updated_at }}</span>
                   </div>

                   <div class="tab-navigation">
                       <div class="tab-item active" data-tab="forecast-chart">Forecast Chart</div>
                       <div class="tab-item" data-tab="forecast-table">Detailed Data</div>
                   </div>

                   <div class="parameter-controls">
                       {% for param in aqi_parameters %}
                       <button class="parameter-btn {% if forloop.first %}active{% endif %}" data-param="{{ param }}">
                           {% if param == 'pm25' %}<i class="fas fa-lungs"></i> PM2.5
                           {% elif param == 'pm10' %}<i class="fas fa-dust"></i> PM10
                           {% elif param == 'no2' %}<i class="fas fa-smog"></i> NO₂
                           {% elif param == 'o3' %}<i class="fas fa-cloud"></i> O₃
                           {% elif param == 'so2' %}<i class="fas fa-industry"></i> SO₂
                           {% elif param == 'co' %}<i class="fas fa-car"></i> CO
                           {% elif param == 'nh3' %}<i class="fas fa-flask"></i> NH₃
                           {% endif %}
                       </button>
                       {% endfor %}
                   </div>

                   <div class="tab-content" id="forecast-chart">
                       <div class="forecast-chart-container">
                           <canvas id="forecastChart"></canvas>
                       </div>
                   </div>

                   <div class="tab-content" id="forecast-table" style="display: none;">
                       <div class="table-responsive">
                           <table class="forecast-table">
                               <thead>
                                   <tr>
                                       <th>Date</th>
                                       <th>Value</th>
                                       <th>WHO Limit</th>
                                       <th>Impact</th>
                                   </tr>
                               </thead>
                               <tbody id="forecast-table-body">
                                   <!-- Will be populated by JavaScript -->
                               </tbody>
                           </table>
                       </div>
                   </div>
               </div>
           </div>

           <!-- Personalized Recommendations Section -->
           <div class="col-12">
               <div class="metric-card" id="recommendations">
                   <div class="card-header-custom">
                       <h3 class="card-title"><i class="fas fa-lightbulb"></i> Recommendations</h3>
                   </div>
                   <div id="recommendation-cards">
                       <!-- Will be populated by JavaScript -->
                   </div>
               </div>
           </div>

           <!-- Health Details Section -->
           <div class="col-12">
               <div class="metric-card detail-section">
                   <div class="card-header-custom">
                       <h3 class="card-title"><i class="fas fa-clipboard-list"></i> Health Assessment</h3>
                   </div>
                   <div class="table-responsive">
                       <table class="table detail-table">
                           <tbody>
                               {% for label, details in radar_details.items %}
                               <tr>
                                   <td width="30%">{{ label }}</td>
                                   <td>
                                       {% if details and details|length > 0 %}
                                           {% for item in details %}
                                           <span class="pill-badge">{{ item }}</span>
                                           {% endfor %}
                                       {% else %}
                                           No data available
                                       {% endif %}
                                   </td>
                               </tr>
                               {% endfor %}
                           </tbody>
                       </table>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
   <script>
       // Set current date
       const currentDate = new Date();
       document.getElementById('current-date').textContent = currentDate.toLocaleDateString('en-US', {
           weekday: 'short',
           year: 'numeric',
           month: 'short',
           day: 'numeric'
       });

       // Last updated time
       const lastUpdated = new Date();
       document.getElementById('last-updated').textContent = lastUpdated.toLocaleTimeString('en-US', {
           hour: '2-digit',
           minute: '2-digit'
       });

      // Define the forecast data (this will be injected from Django)
      const forecastData = {{ forecast_data|safe }};

      // Define WHO limits for reference
      const WHO_LIMITS = {
          "co": 4,
          "so2": 40,
          "pm25": 15,
          "pm10": 45,
          "no2": 28,
          "o3": 64,
          "nh3": 200
      };

      // Health assessment data
      const healthAssessment = {
          respiratory_conditions: "{{ assessment.respiratory_conditions }}".split(','),
          living_environment: "{{ assessment.living_environment }}".split(','),
          smoking_history: "{{ assessment.smoking_history }}",
          occupational_exposure: "{{ assessment.occupational_exposure }}"
      };

      // Check if user has specific conditions
      const hasAsthma = healthAssessment.respiratory_conditions.includes("Asthma");
      const hasCOPD = healthAssessment.respiratory_conditions.includes("COPD");
      const isSmoker = healthAssessment.smoking_history.includes("Current smoker");

      // Function to determine health impact based on parameter and value
      function getHealthImpact(parameter, value) {
          const limit = WHO_LIMITS[parameter];

          // Adjust limit based on health conditions
          let adjustedLimit = limit;
          if (hasAsthma || hasCOPD) {
              adjustedLimit *= 0.7; // More sensitive threshold for respiratory conditions
          }
          if (isSmoker) {
              adjustedLimit *= 0.8; // More sensitive threshold for smokers
          }

          const ratio = value / adjustedLimit;

          if (ratio <= 0.8) {
              return { status: "Good", class: "text-success" };
          } else if (ratio <= 1.2) {
              return { status: "Moderate", class: "text-warning" };
          } else {
              return { status: "Caution", class: "text-danger" };
          }
      }

      // Initialize chart with default parameter (pm25)
      let chart;
      function initChart(parameter = 'pm25') {
          const ctx = document.getElementById('forecastChart').getContext('2d');

          // Get parameter display name
          const paramNames = {
              'pm25': 'PM2.5',
              'pm10': 'PM10',
              'no2': 'NO₂',
              'o3': 'O₃',
              'so2': 'SO₂',
              'co': 'CO',
              'nh3': 'NH₃'
          };

          // Get parameter color
          const paramColors = {
              'pm25': 'rgba(247, 37, 133, 1)',
              'pm10': 'rgba(67, 97, 238, 1)',
              'no2': 'rgba(76, 201, 240, 1)',
              'o3': 'rgba(114, 9, 183, 1)',
              'so2': 'rgba(249, 65, 68, 1)',
              'co': 'rgba(67, 170, 139, 1)',
              'nh3': 'rgba(58, 12, 163, 1)'
          };

          // Extract dates and values
          const dates = forecastData.map(entry => entry.day);
          const values = forecastData.map(entry => entry[`${parameter}_max`]);

          // Add WHO limit reference line
          const whoLimit = WHO_LIMITS[parameter];
          const limits = Array(dates.length).fill(whoLimit);

          // Destroy previous chart if exists
          if (chart) {
              chart.destroy();
          }

          // Create new chart
          chart = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: dates,
                  datasets: [
                      {
                          label: `${paramNames[parameter]}`,
                          data: values,
                          backgroundColor: paramColors[parameter].replace('1', '0.2'),
                          borderColor: paramColors[parameter],
                          borderWidth: 2,
                          tension: 0.3,
                          pointRadius: 4,
                          pointHoverRadius: 6
                      },
                      {
                          label: 'WHO Limit',
                          data: limits,
                          borderColor: 'rgba(128, 128, 128, 0.7)',
                          borderWidth: 2,
                          borderDash: [5, 5],
                          fill: false,
                          pointRadius: 0
                      }
                  ]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          position: 'top',
                          labels: {
                              boxWidth: 10,
                              usePointStyle: true,
                              pointStyle: 'circle',
                              padding: 15,
                              font: {
                                  size: 10
                              }
                          }
                      },
                      tooltip: {
                          backgroundColor: 'rgba(255, 255, 255, 0.95)',
                          titleColor: '#2b2d42',
                          bodyColor: '#6c757d',
                          borderColor: paramColors[parameter],
                          borderWidth: 1,
                          padding: 8,
                          titleFont: {
                              weight: 'bold',
                              size: 12
                          },
                          bodyFont: {
                              size: 11
                          }
                      }
                  },
                  scales: {
                      y: {
                          beginAtZero: false,
                          grid: {
                              color: 'rgba(0, 0, 0, 0.05)',
                              drawBorder: false
                          },
                          ticks: {
                              font: {
                                  size: 10
                              },
                              color: '#6c757d'
                          },
                          title: {
                              display: true,
                              text: 'μg/m³',
                              font: {
                                  size: 10
                              },
                              color: '#2b2d42'
                          }
                      },
                      x: {
                          grid: {
                              color: 'rgba(0, 0, 0, 0.03)',
                              drawBorder: false
                          },
                          ticks: {
                              font: {
                                  size: 10
                              },
                              color: '#6c757d'
                          }
                      }
                  }
              }
          });

          // Update forecast table
          updateForecastTable(parameter);

          // Update health recommendations
          updateHealthRecommendations(parameter);
      }

      // Update the forecast table
      function updateForecastTable(parameter) {
          const tableBody = document.getElementById('forecast-table-body');
          tableBody.innerHTML = '';

          forecastData.forEach(day => {
              const value = day[`${parameter}_max`];
              const impact = getHealthImpact(parameter, value);
              const whoLimit = WHO_LIMITS[parameter];

              const ratio = (value / whoLimit * 100).toFixed(0);
              let comparisonText = '';
              let comparisonClass = '';

              if (ratio <= 80) {
                  comparisonText = `${ratio}% (Below)`;
                  comparisonClass = 'text-success';
              } else if (ratio <= 120) {
                  comparisonText = `${ratio}% (Near)`;
                  comparisonClass = 'text-warning';
              } else {
                  comparisonText = `${ratio}% (Above)`;
                  comparisonClass = 'text-danger';
              }

              const row = document.createElement('tr');
              row.innerHTML = `
                  <td>${day.day}</td>
                  <td>${value}</td>
                  <td class="${comparisonClass}">${comparisonText}</td>
                  <td class="${impact.class}">${impact.status}</td>
              `;

              tableBody.appendChild(row);
          });
      }

      // Update health recommendations based on forecast data and health assessment
      function updateHealthRecommendations(parameter) {
          const recommendationsContainer = document.getElementById('recommendation-cards');
          recommendationsContainer.innerHTML = '';

          // Extract maximum values for the selected parameter
          const maxValue = Math.max(...forecastData.map(day => day[`${parameter}_max`]));
          const whoLimit = WHO_LIMITS[parameter];

          // Generate recommendations based on parameter, value, and health conditions
          const recommendations = [];

          // PM2.5 recommendations
          if (parameter === 'pm25') {
              if (maxValue > whoLimit * 1.2) {
                  if (hasAsthma || hasCOPD) {
                      recommendations.push({
                          title: "Mask Recommendation",
                          content: "Consider using an N95 mask when outdoors as PM2.5 levels will be elevated.",
                          icon: "fas fa-head-side-mask"
                      });
                      recommendations.push({
                          title: "Medication Access",
                          content: "Keep rescue medications accessible during elevated PM2.5 periods.",
                          icon: "fas fa-prescription-bottle-medical"
                      });
                  } else {
                      recommendations.push({
                          title: "Outdoor Activity",
                          content: "Consider limiting extended outdoor activities during peak pollution hours.",
                          icon: "fas fa-person-walking"
                      });
                  }
                  recommendations.push({
                      title: "Air Purification",
                      content: "Running air purifiers indoors can help reduce exposure to fine particles.",
                      icon: "fas fa-fan"
                  });
              } else if (maxValue > whoLimit) {
                  recommendations.push({
                      title: "Moderate Levels Notice",
                      content: "PM2.5 levels will be near guideline levels. Monitor conditions if sensitive.",
                      icon: "fas fa-lungs"
                  });
              } else {
                  recommendations.push({
                      title: "Good Air Quality",
                      content: "PM2.5 levels are within healthy guidelines. Great for outdoor activities!",
                      icon: "fas fa-check-circle"
                  });
              }
          }

          // Add recommendations for other parameters
          if (parameter === 'pm10' && maxValue > whoLimit) {
              recommendations.push({
                  title: "Dust Protection",
                  content: "Consider wearing a dust mask when outdoors during high PM10 levels.",
                  icon: "fas fa-mask"
              });
          }

          if (parameter === 'no2' && maxValue > whoLimit) {
              recommendations.push({
                  title: "Traffic Exposure",
                  content: "Try to avoid high-traffic areas when NO₂ levels are elevated.",
                  icon: "fas fa-car"
              });
          }

          if (parameter === 'o3' && maxValue > whoLimit) {
              recommendations.push({
                  title: "Ozone Warning",
                  content: "Limit outdoor activities between 11am-5pm when ozone levels are typically highest.",
                  icon: "fas fa-sun"
              });
          }

          // Add recommendations to the container
          recommendations.forEach(recommendation => {
              const card = document.createElement('div');
              card.className = `recommendation-card`;

              card.innerHTML = `
                  <div class="recommendation-icon">
                      <i class="${recommendation.icon}"></i>
                  </div>
                  <div class="recommendation-content">
                      <h4>${recommendation.title}</h4>
                      <p>${recommendation.content}</p>
                      <div class="recommendation-actions">
                          <a href="#" class="btn-recommendation">
                              <i class="fas fa-arrow-right"></i> Learn More
                          </a>
                      </div>
                  </div>
              `;

              recommendationsContainer.appendChild(card);
          });

          // If no recommendations, add default message
          if (recommendations.length === 0) {
              const card = document.createElement('div');
              card.className = `recommendation-card`;

              card.innerHTML = `
                  <div class="recommendation-icon">
                      <i class="fas fa-info-circle"></i>
                  </div>
                  <div class="recommendation-content">
                      <h4>No Special Precautions</h4>
                      <p>Based on current forecasts, no specific precautions are needed for ${parameter.toUpperCase()}.</p>
                  </div>
              `;

              recommendationsContainer.appendChild(card);
          }
      }

      // Handle parameter button clicks
      document.querySelectorAll('.parameter-btn').forEach(button => {
          button.addEventListener('click', function() {
              // Update active state
              document.querySelectorAll('.parameter-btn').forEach(btn => btn.classList.remove('active'));
              this.classList.add('active');

              // Update chart and table
              const parameter = this.getAttribute('data-param');
              initChart(parameter);
          });
      });

      // Tab navigation
      document.querySelectorAll('.tab-item').forEach(tab => {
          tab.addEventListener('click', function() {
              // Update active state
              document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
              this.classList.add('active');

              // Show corresponding content
              const tabId = this.getAttribute('data-tab');
              document.querySelectorAll('.tab-content').forEach(content => {
                  content.style.display = 'none';
              });
              document.getElementById(tabId).style.display = 'block';
          });
      });

      // Mobile tabs
      document.querySelectorAll('.mobile-tab').forEach(tab => {
          tab.addEventListener('click', function() {
              // Update active state
              document.querySelectorAll('.mobile-tab').forEach(item => item.classList.remove('active'));
              this.classList.add('active');

              // Show corresponding content
              const sectionId = this.getAttribute('data-target');
              document.querySelectorAll('.mobile-section').forEach(section => {
                  section.classList.remove('active');
              });
              document.getElementById(sectionId).classList.add('active');
          });
      });

      // Initialize with PM2.5 data when the document is loaded
      document.addEventListener('DOMContentLoaded', function() {
          // Initialize the chart with PM2.5 data
          initChart('pm25');

          // Set up polling for latest data
          function fetchLatestData() {
              $.ajax({
                  url: window.location.pathname,
                  type: "GET",
                  dataType: "json",
                  headers: { "X-Requested-With": "XMLHttpRequest" },
                  success: function(data) {
                      // Update AQI data if available
                      if (data.aqi_data) {
                          updateAqiContainer(data.aqi_data);
                      }

                      // Update forecast data if available
                      if (data.forecast_data) {
                          forecastData = data.forecast_data;
                          const activeParam = document.querySelector('.parameter-btn.active').getAttribute('data-param');
                          initChart(activeParam);
                      }

                      // Update last updated time
                      const updatedTime = new Date();
                      document.getElementById('last-updated').textContent = updatedTime.toLocaleTimeString('en-US', {
                          hour: '2-digit',
                          minute: '2-digit'
                      });
                  },
                  error: function(xhr, status, error) {
                      console.error("AJAX error:", error);
                  }
              });
          }

          // Function to update AQI container values
          function updateAqiContainer(aqiData) {
              if (aqiData.co_level) $('#co').text(aqiData.co_level);
              if (aqiData.no2_level) $('#no2').text(aqiData.no2_level);
              if (aqiData.pm25_level) $('#pm25').text(aqiData.pm25_level);
              if (aqiData.pm10_level) $('#pm10').text(aqiData.pm10_level);
              if (aqiData.so2_level) $('#so2').text(aqiData.so2_level);
              if (aqiData.nh3_level) $('#nh3').text(aqiData.nh3_level);
              if (aqiData.o3_level) $('#o3').text(aqiData.o3_level);

              // Add visual indicators for high values
              highlightDangerousValues();
          }

          // Function to highlight dangerous values
          function highlightDangerousValues() {
              // For SO2
              const so2Value = parseFloat($('#so2').text());
              if (!isNaN(so2Value) && so2Value > 200) {
                  $('#so2').css({ color: 'red', fontWeight: 'bold' });
              } else {
                  $('#so2').css({ color: '', fontWeight: '' });
              }

              // For NO2
              const no2Value = parseFloat($('#no2').text());
              if (!isNaN(no2Value) && no2Value > 200) {
                  $('#no2').css({ color: 'red', fontWeight: 'bold' });
              } else {
                  $('#no2').css({ color: '', fontWeight: '' });
              }

              // For PM2.5
              const pm25Value = parseFloat($('#pm25').text());
              if (!isNaN(pm25Value) && pm25Value > 35) {
                  $('#pm25').css({ color: 'red', fontWeight: 'bold' });
              } else {
                  $('#pm25').css({ color: '', fontWeight: '' });
              }
          }

          // Call immediately for first update
          fetchLatestData();

          // Then poll for updates every 60 seconds
          setInterval(fetchLatestData, 1000);
      });
   </script>

   <script>
   // Function to get user's location and update the display
   function getUserLocation() {
     const locationValueElement = document.querySelector('.overview-item:nth-child(2) .overview-value');

     // Check if geolocation is supported by the browser
     if (navigator.geolocation) {
       // Show loading message with spinner
       locationValueElement.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 4px;"></i> Detecting...';

       // Get current position
       navigator.geolocation.getCurrentPosition(
         // Success callback
         async function(position) {
           try {
             // Get coordinates
             const latitude = position.coords.latitude;
             const longitude = position.coords.longitude;

             // Reverse geocoding to get location name - with more precision
             const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`);

             if (response.ok) {
               const data = await response.json();

               // Extract more detailed location information
               let locationName = "";

               if (data.address) {
                 // Try to get the most precise location first
                 const road = data.address.road || data.address.street;
                 const houseNumber = data.address.house_number;
                 const building = data.address.building;
                 const neighbourhood = data.address.neighbourhood || data.address.suburb;
                 const locality = data.address.locality;
                 const district = data.address.district;
                 const city = data.address.city || data.address.town || data.address.village;
                 const county = data.address.county;
                 const state = data.address.state;

                 // Construct the location name with the most precise information available
                 if (road) {
                   if (houseNumber) {
                     locationName = `${houseNumber} ${road}`;
                   } else {
                     locationName = road;
                   }

                   // Add neighborhood or locality if available
                   if (neighbourhood) {
                     locationName += `, ${neighbourhood}`;
                   } else if (locality) {
                     locationName += `, ${locality}`;
                   }

                   // Add city if available and not redundant
                   if (city && !locationName.includes(city)) {
                     locationName += `, ${city}`;
                   }
                 } else if (neighbourhood) {
                   locationName = neighbourhood;
                   if (city) {
                     locationName += `, ${city}`;
                   }
                 } else if (locality) {
                   locationName = locality;
                   if (city) {
                     locationName += `, ${city}`;
                   }
                 } else if (city) {
                   locationName = city;
                   if (district) {
                     locationName = `${district}, ${city}`;
                   }
                 } else if (county) {
                   locationName = county;
                 } else if (state) {
                   locationName = state;
                 } else {
                   locationName = data.address.country || "Unknown Location";
                 }
               } else {
                 locationName = "Unknown Location";
               }

               // Update location display
               locationValueElement.textContent = locationName;
             } else {
               // Fallback to coordinates if reverse geocoding fails
               locationValueElement.textContent = `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
             }
           } catch (error) {
             console.error("Error getting location name:", error);
             locationValueElement.textContent = "Location Error";
           }
         },
         // Error callback
         function(error) {
           console.error("Geolocation error:", error);

           let errorMessage;
           switch(error.code) {
             case error.PERMISSION_DENIED:
               errorMessage = "Permission Denied";
               break;
             case error.POSITION_UNAVAILABLE:
               errorMessage = "Position Unavailable";
               break;
             case error.TIMEOUT:
               errorMessage = "Request Timeout";
               break;
             default:
               errorMessage = "Unknown Error";
           }

           locationValueElement.textContent = errorMessage;
         },
         // Options
         {
           enableHighAccuracy: true,
           timeout: 10000,
           maximumAge: 0
         }
       );
     } else {
       // Geolocation is not supported
       locationValueElement.textContent = "Not Supported";
       console.log("Geolocation is not supported by this browser.");
     }
   }

   // Call the function when the document is loaded
   document.addEventListener('DOMContentLoaded', function() {
     // Get user location
     getUserLocation();

     // Add a refresh button and location icon next to location
     const locationItem = document.querySelector('.overview-item:nth-child(2)');

     // Add location icon to make it clear this is the current location
     const locationLabel = locationItem.querySelector('.overview-label');
     locationLabel.innerHTML = '<i class="fas fa-map-marker-alt" style="margin-right: 4px;"></i> Location';

     // Create refresh button
     const refreshButton = document.createElement('button');
     refreshButton.innerHTML = '<i class="fas fa-sync-alt"></i>';
     refreshButton.className = 'location-refresh-btn';
     refreshButton.title = 'Update my location';
     refreshButton.style.background = 'none';
     refreshButton.style.border = 'none';
     refreshButton.style.color = 'var(--primary)';
     refreshButton.style.cursor = 'pointer';
     refreshButton.style.marginLeft = '4px';
     refreshButton.style.fontSize = '0.7rem';
     refreshButton.style.opacity = '0.7';
     refreshButton.style.transition = 'var(--transition)';

     refreshButton.addEventListener('mouseenter', function() {
       this.style.opacity = '1';
       this.style.transform = 'rotate(30deg)';
     });

     refreshButton.addEventListener('mouseleave', function() {
       this.style.opacity = '0.7';
       this.style.transform = 'rotate(0)';
     });

     refreshButton.addEventListener('click', function() {
       getUserLocation();
       this.style.transform = 'rotate(360deg)';
       setTimeout(() => {
         this.style.transform = 'rotate(0)';
       }, 500);
     });

     const locationValueSpan = locationItem.querySelector('.overview-value');
     locationItem.style.display = 'flex';
     locationItem.style.alignItems = 'center';
     locationItem.style.justifyContent = 'center';
     locationValueSpan.parentNode.insertBefore(refreshButton, locationValueSpan.nextSibling);
   });
   </script>
</body>
</html>